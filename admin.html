<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Control System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #34495e;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #3498db;
    }

    .subtitle {
      font-size: 1.2rem;
      color: #95a5a6;
    }

    .panels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .panel {
      background: rgba(30, 40, 50, 0.8);
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid #34495e;
    }

    .panel h2 {
      color: #2ecc71;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel h2 i {
      font-size: 1.3rem;
    }

    .btn {
      display: inline-block;
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      margin: 5px;
    }

    .btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: #2ecc71;
    }

    .btn-success:hover {
      background: #27ae60;
    }

    .btn-warning {
      background: #f39c12;
    }

    .btn-warning:hover {
      background: #d35400;
    }

    .btn-disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      background: #7f8c8d;
      transform: none;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background: #2ecc71;
    }

    .status-disconnected {
      background: #e74c3c;
    }

    .status-connecting {
      background: #f39c12;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .log-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      margin-top: 15px;
    }

    .log-entry {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #34495e;
    }

    .log-time {
      color: #95a5a6;
      font-size: 0.8rem;
    }

    .log-message {
      color: #e0e0e0;
    }

    .log-error {
      color: #e74c3c;
    }

    .log-success {
      color: #2ecc71;
    }

    .log-warning {
      color: #f39c12;
    }

    .log-info {
      color: #3498db;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #34495e;
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3498db;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #3498db;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #95a5a6;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #34495e;
      color: #95a5a6;
      font-size: 0.9rem;
    }

    .connection-status {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.2);
    }

    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .test-buttons .btn {
      flex: 1;
      min-width: 120px;
    }

    /* NUOVI STILI PER CONTROLLO SLIDER */
    .slider-control-panel {
      margin-top: 20px;
    }

    .slider-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
    }

    .slider-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .status-enabled {
      background: #2ecc71;
      box-shadow: 0 0 8px #2ecc71;
    }

    .status-disabled {
      background: #e74c3c;
      box-shadow: 0 0 8px #e74c3c;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e74c3c;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #2ecc71;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }

    .slider-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .slider-control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .slider-control-item.disabled {
      opacity: 0.5;
      background: rgba(255, 0, 0, 0.1);
    }

    .slider-control-item.enabled {
      background: rgba(0, 255, 0, 0.1);
    }

    .slider-control-label {
      font-size: 0.8rem;
      margin-bottom: 5px;
      text-align: center;
    }

    .slider-control-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #3498db;
    }

    .control-section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #34495e;
    }

    .control-section:last-child {
      border-bottom: none;
    }

    .broadcast-message {
      background: rgba(52, 152, 219, 0.2);
      border: 1px solid #3498db;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }

    .broadcast-message h4 {
      margin-bottom: 10px;
      color: #3498db;
    }

    .message-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .message-input input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #34495e;
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .message-input button {
      padding: 8px 15px;
    }

    /* NUOVI STILI PER LO STREAMING VIDEO */
    .streaming-panel {
      grid-column: span 2;
    }

    .video-container {
      position: relative;
      width: 100%;
      height: 400px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .video-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .stream-stats {
      display: flex;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .stream-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .stream-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2ecc71;
    }

    .stream-stat-label {
      font-size: 0.8rem;
      color: #95a5a6;
      margin-top: 5px;
    }

    .stream-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .quality-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quality-selector select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #34495e;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .stream-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
    }

    .stream-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e74c3c;
      animation: pulse 2s infinite;
    }

    .stream-indicator.live {
      background: #2ecc71;
    }

    @media (max-width: 768px) {
      .streaming-panel {
        grid-column: span 1;
      }
      
      .panels-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <header>
      <h1>Admin Control Panel</h1>
      <p class="subtitle">Gestisci il questionario, gli slider, lo streaming e monitora il sistema</p>
    </header>

    <div class="panels-grid">
      <!-- Panel Stato Connessione -->
      <div class="panel">
        <h2><i>üîå</i> Stato Connessione</h2>
        <div class="connection-status">
          <span class="status-indicator status-connecting" id="statusIndicator"></span>
          <span id="connectionText">Connessione in corso...</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="messageCount">0</div>
            <div class="stat-label">Messaggi Ricevuti</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="sliderCount">0</div>
            <div class="stat-label">Slider Attivi</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="questionnaireCount">0</div>
            <div class="stat-label">Questionari Inviati</div>
          </div>
        </div>
      </div>

      <!-- Panel Gestione Questionario -->
      <div class="panel">
        <h2><i>üìù</i> Gestione Questionario</h2>
        <p>Stato attuale: <strong id="questionnaireStatus">Sconosciuto</strong></p>
        <div class="test-buttons">
          <button class="btn btn-success" id="resetQuestionnaireBtn">Resetta Questionario</button>
          <button class="btn btn-warning" id="simulateQuestionnaireBtn">Simula Questionario</button>
        </div>
        <div class="form-group">
          <label for="questionnaireUrl">URL Questionario:</label>
          <input type="text" id="questionnaireUrl" value="https://tuosito.com" readonly>
          <button class="btn" id="copyUrlBtn">Copia URL</button>
        </div>
      </div>

      <!-- NUOVO: Panel Streaming Video -->
      <div class="panel streaming-panel">
        <h2><i>üìπ</i> Live Streaming</h2>
        
        <div class="stream-status">
          <span class="stream-indicator" id="streamIndicator"></span>
          <span id="streamStatusText">Streaming non attivo</span>
        </div>
        
        <div class="video-container">
          <iframe src="https://vdo.ninja/?view=Ha93mG8d" 
                  allow="camera; microphone; fullscreen; display-capture" 
                  id="streamFrame">
          </iframe>
        </div>
        
        <div class="stream-stats">
          <div class="stream-stat">
            <div class="stream-stat-value" id="fpsValue">0</div>
            <div class="stream-stat-label">FPS</div>
          </div>
          <div class="stream-stat">
            <div class="stream-stat-value" id="uploadSpeedValue">0 KB/s</div>
            <div class="stream-stat-label">Velocit√† Upload</div>
          </div>
          <div class="stream-stat">
            <div class="stream-stat-value" id="bitrateValue">0 kbps</div>
            <div class="stream-stat-label">Bitrate</div>
          </div>
          <div class="stream-stat">
            <div class="stream-stat-value" id="latencyValue">0 ms</div>
            <div class="stream-stat-label">Latenza</div>
          </div>
        </div>
        
        <div class="stream-controls">
          <button class="btn" id="refreshStreamBtn">Aggiorna Stream</button>
          <div class="quality-selector">
            <label for="streamQuality">Qualit√†:</label>
            <select id="streamQuality">
              <option value="auto">Auto</option>
              <option value="hd">HD (720p)</option>
              <option value="sd">SD (480p)</option>
              <option value="low">Bassa (360p)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Panel Controllo Slider -->
      <div class="panel">
        <h2><i>üéöÔ∏è</i> Controllo Slider</h2>
        
        <div class="slider-control-panel">
          <div class="slider-status">
            <div class="slider-status-indicator">
              <span class="status-dot status-disabled" id="sliderGlobalStatus"></span>
              <span id="sliderStatusText">Sliders Disabilitati</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sliderToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="slider-controls" id="sliderControls">
            <!-- I controlli slider verranno generati dinamicamente -->
          </div>

          <div class="test-buttons">
            <button class="btn btn-success" id="enableAllSlidersBtn">Abilita Tutti</button>
            <button class="btn btn-danger" id="disableAllSlidersBtn">Disabilita Tutti</button>
            <button class="btn" id="resetSlidersBtn">Reset Valori Globali</button>
          </div>
        </div>
      </div>

   <!-- Panel Test WebSocket -->
<div class="panel">
  <h2><i>üîß</i> Test WebSocket</h2>
  <div class="test-buttons">
    <button class="btn" id="testConnectionBtn">Test Connessione</button>
    <button class="btn btn-warning" id="testSliderBtn">Test Slider</button>
    <button class="btn btn-warning" id="testHandBtn">Test Mano</button>
    <!-- NUOVO BOTTONE PER TEST MESSAGGI SPETTATORE -->
    <button class="btn btn-success" id="testSpectatorMessagesBtn">Test 10 Messaggi Spettatore</button>
  </div>

  <div class="broadcast-message" style="margin-top: 20px;">
    <h4>üé≠ Controllo Performance</h4>
    <p>Gestisci il feedback finale</p>
    <div class="test-buttons">
      <button class="btn btn-success" id="showFeedbackBtn">Mostra Feedback Overlay</button>
      <button class="btn btn-danger" id="hideFeedbackBtn">Nascondi Feedback</button>
    </div>
  </div>

  <div class="broadcast-message">
    <h4>üì¢ Messaggio Broadcast</h4>
    <p>Invia un messaggio a tutti i client connessi</p>
    <div class="message-input">
      <input type="text" id="broadcastMessage" placeholder="Inserisci il messaggio...">
      <button class="btn" id="sendBroadcastBtn">Invia</button>
    </div>
  </div>

  <div class="form-group">
    <label for="customMessage">Messaggio Personalizzato:</label>
    <input type="text" id="customMessage" placeholder='{"type": "test", "message": "Hello"}'>
    <button class="btn" id="sendCustomBtn">Invia Messaggio</button>
  </div>
</div>

      <!-- Panel Log Sistema -->
      <div class="panel">
        <h2><i>üìä</i> Log Sistema</h2>
        <div class="log-container" id="logContainer">
          <div class="log-entry">
            <span class="log-time">[00:00:00]</span>
            <span class="log-info log-message">Sistema admin inizializzato</span>
          </div>
        </div>
        <div class="test-buttons">
          <button class="btn" id="clearLogBtn">Pulisci Log</button>
          <button class="btn btn-warning" id="exportLogBtn">Esporta Log</button>
        </div>
      </div>
    </div>

    <footer>
      <p>Admin Panel - Control System | Eburnea Performance</p>
    </footer>
  </div>
  <div class="test-buttons">
  <button class="btn" id="testConnectionBtn">Test Connessione</button>
  <button class="btn btn-warning" id="testSliderBtn">Test Slider</button>
  <button class="btn btn-warning" id="testHandBtn">Test Mano</button>
  <!-- NUOVO BOTTONE PER TEST MESSAGGI SPETTATORE -->
  <button class="btn btn-success" id="testSpectatorMessagesBtn">Test 10 Messaggi Spettatore</button>
</div>

  <script>
    // Elementi DOM
    const statusIndicator = document.getElementById('statusIndicator');
    const connectionText = document.getElementById('connectionText');
    const messageCountEl = document.getElementById('messageCount');
    const sliderCountEl = document.getElementById('sliderCount');
    const questionnaireCountEl = document.getElementById('questionnaireCount');
    const questionnaireStatus = document.getElementById('questionnaireStatus');
    const resetQuestionnaireBtn = document.getElementById('resetQuestionnaireBtn');
    const simulateQuestionnaireBtn = document.getElementById('simulateQuestionnaireBtn');
    const questionnaireUrl = document.getElementById('questionnaireUrl');
    const copyUrlBtn = document.getElementById('copyUrlBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const testSliderBtn = document.getElementById('testSliderBtn');
    const testHandBtn = document.getElementById('testHandBtn');
    const customMessage = document.getElementById('customMessage');
    const sendCustomBtn = document.getElementById('sendCustomBtn');
    const logContainer = document.getElementById('logContainer');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const exportLogBtn = document.getElementById('exportLogBtn');

    // Nuovi elementi per il controllo slider
    const sliderToggle = document.getElementById('sliderToggle');
    const sliderGlobalStatus = document.getElementById('sliderGlobalStatus');
    const sliderStatusText = document.getElementById('sliderStatusText');
    const sliderControls = document.getElementById('sliderControls');
    const enableAllSlidersBtn = document.getElementById('enableAllSlidersBtn');
    const disableAllSlidersBtn = document.getElementById('disableAllSlidersBtn');
    const resetSlidersBtn = document.getElementById('resetSlidersBtn');
    const broadcastMessage = document.getElementById('broadcastMessage');
    const sendBroadcastBtn = document.getElementById('sendBroadcastBtn');

    // Nuovi elementi per lo streaming
    const streamIndicator = document.getElementById('streamIndicator');
    const streamStatusText = document.getElementById('streamStatusText');
    const streamFrame = document.getElementById('streamFrame');
    const fpsValue = document.getElementById('fpsValue');
    const uploadSpeedValue = document.getElementById('uploadSpeedValue');
    const bitrateValue = document.getElementById('bitrateValue');
    const latencyValue = document.getElementById('latencyValue');
    const refreshStreamBtn = document.getElementById('refreshStreamBtn');
    const streamQuality = document.getElementById('streamQuality');

    // Variabili di stato
    let messageCount = 0;
    let sliderCount = 0;
    let questionnaireCount = 0;
    let ws = null;
    let slidersEnabled = true;
    let sliderValues = {};
    
    // Variabili per lo streaming
    let streamStatsInterval;
    let simulatedFPS = 0;
    let simulatedUploadSpeed = 0;
    let simulatedBitrate = 0;
    let simulatedLatency = 0;

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
      logMessage('Sistema admin inizializzato', 'info');
      updateQuestionnaireStatus();
      connectWebSocket();
      initializeSliderControls();
      initializeStreamMonitoring();
      
      // Imposta l'URL corrente
      questionnaireUrl.value = window.location.origin;
    });

    // Inizializza il monitoraggio dello streaming
    function initializeStreamMonitoring() {
      // Simula statistiche dello streaming (in un caso reale, queste verrebbero da un'API)
      startStreamStatsSimulation();
      
      // Aggiorna lo stato dello streaming
      updateStreamStatus(true);
      
      // Aggiungi event listener per il pulsante di aggiornamento
      refreshStreamBtn.addEventListener('click', () => {
        refreshStream();
      });
      
      // Aggiungi event listener per il selettore di qualit√†
      streamQuality.addEventListener('change', () => {
        updateStreamQuality(streamQuality.value);
      });
    }

    // Simula statistiche dello streaming
    function startStreamStatsSimulation() {
      clearInterval(streamStatsInterval);
      
      streamStatsInterval = setInterval(() => {
        // Simula valori realistici per uno streaming
        simulatedFPS = Math.floor(Math.random() * 10) + 25; // 25-35 FPS
        simulatedUploadSpeed = Math.floor(Math.random() * 500) + 500; // 500-1000 KB/s
        simulatedBitrate = Math.floor(Math.random() * 1000) + 1500; // 1500-2500 kbps
        simulatedLatency = Math.floor(Math.random() * 100) + 50; // 50-150 ms
        
        // Aggiorna i valori visualizzati
        updateStreamStats();
      }, 2000);
    }

    // Aggiorna le statistiche dello streaming
    function updateStreamStats() {
      fpsValue.textContent = simulatedFPS;
      uploadSpeedValue.textContent = simulatedUploadSpeed + ' KB/s';
      bitrateValue.textContent = simulatedBitrate + ' kbps';
      latencyValue.textContent = simulatedLatency + ' ms';
    }

    // Aggiorna lo stato dello streaming
    function updateStreamStatus(isActive) {
      if (isActive) {
        streamIndicator.className = 'stream-indicator live';
        streamStatusText.textContent = 'Streaming Live';
        logMessage('Streaming attivo', 'success');
      } else {
        streamIndicator.className = 'stream-indicator';
        streamStatusText.textContent = 'Streaming non attivo';
        logMessage('Streaming non attivo', 'warning');
      }
    }

    // Aggiorna la qualit√† dello streaming
    function updateStreamQuality(quality) {
      let newSrc = 'https://vdo.ninja/?view=Ha93mG8';
      
      switch(quality) {
        case 'hd':
          newSrc += '&hd=1';
          break;
        case 'sd':
          newSrc += '&sd=1';
          break;
        case 'low':
          newSrc += '&low=1';
          break;
        default:
          // Auto - nessun parametro aggiuntivo
          break;
      }
      
      streamFrame.src = newSrc;
      logMessage(`Qualit√† streaming impostata a: ${quality}`, 'info');
    }

    // Aggiorna lo stream
    function refreshStream() {
      const currentSrc = streamFrame.src;
      streamFrame.src = '';
      setTimeout(() => {
        streamFrame.src = currentSrc;
        logMessage('Streaming aggiornato', 'info');
      }, 100);
    }

    // Inizializza i controlli slider
    function initializeSliderControls() {
      // Crea i controlli per ogni slider
      for (let i = 1; i <= 7; i++) {
        const sliderControl = document.createElement('div');
        sliderControl.className = 'slider-control-item enabled';
        sliderControl.id = `sliderControl${i}`;
        sliderControl.innerHTML = `
          <span class="slider-control-label">Slider ${i}</span>
          <span class="slider-control-value" id="sliderValue${i}">50</span>
          <div class="test-buttons" style="margin-top: 5px;">
            <button class="btn btn-success btn-small enable-slider" data-slider="${i}">On</button>
            <button class="btn btn-danger btn-small disable-slider" data-slider="${i}">Off</button>
          </div>
        `;
        sliderControls.appendChild(sliderControl);
        
        // Inizializza valori
        sliderValues[i] = 50;
      }
      
      // Imposta lo stato iniziale
      updateSlidersState(true);
      
      // Aggiungi event listeners per i controlli slider
      document.querySelectorAll('.enable-slider').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const sliderId = e.target.getAttribute('data-slider');
          enableSlider(sliderId);
        });
      });
      
      document.querySelectorAll('.disable-slider').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const sliderId = e.target.getAttribute('data-slider');
          disableSlider(sliderId);
        });
      });
    }

    // Abilita/disabilita tutti gli slider
    function updateSlidersState(enabled) {
      slidersEnabled = enabled;
      sliderToggle.checked = enabled;
      
      if (enabled) {
        sliderGlobalStatus.className = 'status-dot status-enabled';
        sliderStatusText.textContent = 'Sliders Abilitati';
        logMessage('Tutti gli slider sono stati abilitati', 'success');
      } else {
        sliderGlobalStatus.className = 'status-dot status-disabled';
        sliderStatusText.textContent = 'Sliders Disabilitati';
        logMessage('Tutti gli slider sono stati disabilitati', 'warning');
      }
      
      // Invia lo stato al server
      sendSliderControlState();
    }

    // Abilita uno slider specifico
    function enableSlider(sliderId) {
      const control = document.getElementById(`sliderControl${sliderId}`);
      control.classList.remove('disabled');
      control.classList.add('enabled');
      logMessage(`Slider ${sliderId} abilitato`, 'success');
      sendIndividualSliderControl(sliderId, true);
    }

    // Disabilita uno slider specifico
    function disableSlider(sliderId) {
      const control = document.getElementById(`sliderControl${sliderId}`);
      control.classList.remove('enabled');
      control.classList.add('disabled');
      logMessage(`Slider ${sliderId} disabilitato`, 'warning');
      sendIndividualSliderControl(sliderId, false);
    }

    // Invia lo stato di controllo degli slider al server
    function sendSliderControlState() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = {
          type: "slider_control",
          enabled: slidersEnabled,
          timestamp: Date.now()
        };
        ws.send(JSON.stringify(message));
        logMessage(`Stato slider inviato: ${slidersEnabled ? 'Abilitati' : 'Disabilitati'}`, 'info');
      }
    }

    // Invia controllo per slider individuale
    function sendIndividualSliderControl(sliderId, enabled) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = {
          type: "slider_control_individual",
          sliderId: parseInt(sliderId),
          enabled: enabled,
          timestamp: Date.now()
        };
        ws.send(JSON.stringify(message));
      }
    }

    // Aggiorna il valore di uno slider
    function updateSliderValue(sliderId, value) {
      const valueElement = document.getElementById(`sliderValue${sliderId}`);
      if (valueElement) {
        valueElement.textContent = value;
        sliderValues[sliderId] = value;
      }
    }
// Funzione per inviare 10 messaggi spettatore contemporaneamente
function sendMultipleSpectatorMessages() {
    const messages = [
        "Questo √® un messaggio di test 1",
        "Interessante performance!",
        "Mi piace molto questo show",
        "I colori sono fantastici",
        "La musica √® coinvolgente",
        "Bravi artisti!",
        "Emozionante!",
        "Che spettacolo meraviglioso",
        "Complimenti per la regia",
        "Voglio vedere di pi√π!"
    ];

    let sentCount = 0;
    
    messages.forEach((message, index) => {
        setTimeout(() => {
            const testData = {
                type: "spectator_message",
                message: message,
                timestamp: Date.now(),
                sessionId: "test_spectator_" + Date.now() + "_" + index,
                submissionCount: index + 1
            };
            
            if (sendWebSocketMessage(testData)) {
                sentCount++;
                logMessage(`Messaggio spettatore ${index + 1}/10 inviato: "${message}"`, 'success');
                
                // Aggiorna il contatore
                questionnaireCount++;
                questionnaireCountEl.textContent = questionnaireCount;
                
                if (sentCount === messages.length) {
                    logMessage('Tutti i 10 messaggi spettatore sono stati inviati', 'success');
                }
            }
        }, index * 300); // Invio ogni 300ms per simulare utenti reali
    });
}
    // Connessione WebSocket
    function connectWebSocket() {
      try {
        updateConnectionStatus('connecting', 'Connessione in corso...');
        
        // Usa lo stesso WebSocket della pagina principale
        ws = new WebSocket('wss://eburnea-fixed-f2da05b9b297.herokuapp.com');
        
        ws.onopen = function(event) {
          updateConnectionStatus('connected', 'Connesso al server');
          logMessage('Connessione WebSocket stabilita', 'success');
          
          // Invia lo stato iniziale degli slider
          sendSliderControlState();
        };

        ws.onclose = function(event) {
          updateConnectionStatus('disconnected', 'Disconnesso dal server');
          logMessage('Connessione WebSocket chiusa', 'warning');
          
          // Tentativo di riconnessione dopo 5 secondi
          setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = function(error) {
          updateConnectionStatus('disconnected', 'Errore di connessione');
          logMessage('Errore WebSocket: ' + error, 'error');
        };

        ws.onmessage = function(event) {
          messageCount++;
          messageCountEl.textContent = messageCount;
          logMessage(`Messaggio ricevuto: ${event.data}`, 'info');
          
          // Analizza il messaggio per aggiornare i contatori
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'slider') {
              sliderCount++;
              sliderCountEl.textContent = sliderCount;
              
              // Aggiorna il valore dello slider nel pannello admin
              if (data.index !== undefined) {
                const sliderId = data.index + 1; // Converti da 0-based a 1-based
                updateSliderValue(sliderId, Math.round(data.value * 100));
              }
            } else if (data.type === 'questionnaire') {
              questionnaireCount++;
              questionnaireCountEl.textContent = questionnaireCount;
            } else if (data.type === 'hand_signal') {
              logMessage(`Segnale mano ricevuto: #${data.count}`, 'info');
            }
          } catch (e) {
            // Ignora errori di parsing
          }
        };
      } catch (error) {
        logMessage('Errore nella connessione WebSocket: ' + error, 'error');
      }
    }

    // Aggiorna lo stato della connessione
    function updateConnectionStatus(status, text) {
      statusIndicator.className = 'status-indicator';
      
      if (status === 'connected') {
        statusIndicator.classList.add('status-connected');
        connectionText.textContent = text;
      } else if (status === 'disconnected') {
        statusIndicator.classList.add('status-disconnected');
        connectionText.textContent = text;
      } else {
        statusIndicator.classList.add('status-connecting');
        connectionText.textContent = text;
      }
    }

    // Aggiorna lo stato del questionario
    function updateQuestionnaireStatus() {
      const isCompleted = localStorage.getItem('questionnaireCompleted') === 'true';
      questionnaireStatus.textContent = isCompleted ? 'Completato' : 'Non completato';
      questionnaireStatus.style.color = isCompleted ? '#2ecc71' : '#e74c3c';
    }

    // Aggiunge un messaggio al log
    function logMessage(message, type = 'info') {
      const now = new Date();
      const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
      
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'log-time';
      timeSpan.textContent = timeString;
      
      const messageSpan = document.createElement('span');
      messageSpan.className = `log-message log-${type}`;
      messageSpan.textContent = ` ${message}`;
      
      logEntry.appendChild(timeSpan);
      logEntry.appendChild(messageSpan);
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Invia un messaggio via WebSocket
    function sendWebSocketMessage(message) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
        logMessage(`Messaggio inviato: ${JSON.stringify(message)}`, 'success');
        return true;
      } else {
        logMessage('WebSocket non connesso, messaggio non inviato', 'error');
        return false;
      }
    }

    // Event Listeners
    resetQuestionnaireBtn.addEventListener('click', () => {
      localStorage.removeItem('questionnaireCompleted');
      localStorage.removeItem('userQuestionnaire');
      localStorage.removeItem('pendingQuestionnaire');
      
      updateQuestionnaireStatus();
      logMessage('Questionario resettato con successo', 'success');
      
      // Notifica anche la pagina principale se √® aperta
      if (window.opener) {
        window.opener.postMessage({ type: 'resetQuestionnaire' }, '*');
      }
    });

    simulateQuestionnaireBtn.addEventListener('click', () => {
      const testData = {
        type: "questionnaire",
        answers: {
          emotion: "curiosit√†",
          color: "blu intenso",
          element: "acqua",
          expectation: "scoperta"
        },
        timestamp: Date.now(),
        sessionId: "test_session_" + Date.now()
      };
      
      if (sendWebSocketMessage(testData)) {
        questionnaireCount++;
        questionnaireCountEl.textContent = questionnaireCount;
        logMessage('Questionario di test inviato', 'success');
      }
    });

    copyUrlBtn.addEventListener('click', () => {
      questionnaireUrl.select();
      document.execCommand('copy');
      logMessage('URL copiato negli appunti', 'success');
    });

    testConnectionBtn.addEventListener('click', () => {
      const testMessage = {
        type: "test",
        message: "Test di connessione dall'admin panel",
        timestamp: Date.now()
      };
      
      sendWebSocketMessage(testMessage);
    });

    testSliderBtn.addEventListener('click', () => {
      const testMessage = {
        type: "slider",
        index: Math.floor(Math.random() * 7),
        value: Math.random(),
        timestamp: Date.now()
      };
      
      if (sendWebSocketMessage(testMessage)) {
        sliderCount++;
        sliderCountEl.textContent = sliderCount;
      }
    });

    testHandBtn.addEventListener('click', () => {
      const testMessage = {
        type: "hand_signal",
        value: 1,
        count: Math.floor(Math.random() * 1000),
        timestamp: Date.now(),
        sessionId: "test_admin_" + Date.now()
      };
      
      sendWebSocketMessage(testMessage);
      logMessage('Segnale mano di test inviato', 'info');
    });

    sendCustomBtn.addEventListener('click', () => {
      try {
        const message = JSON.parse(customMessage.value);
        sendWebSocketMessage(message);
      } catch (e) {
        logMessage('Errore nel parsing del messaggio personalizzato: ' + e, 'error');
      }
    });

    sendBroadcastBtn.addEventListener('click', () => {
      const message = broadcastMessage.value.trim();
      if (message) {
        const broadcastData = {
          type: "broadcast",
          message: message,
          timestamp: Date.now()
        };
        
        if (sendWebSocketMessage(broadcastData)) {
          logMessage(`Messaggio broadcast inviato: "${message}"`, 'success');
          broadcastMessage.value = '';
        }
      } else {
        logMessage('Inserisci un messaggio per il broadcast', 'warning');
      }
    });

    clearLogBtn.addEventListener('click', () => {
      logContainer.innerHTML = '';
      logMessage('Log pulito', 'info');
    });

    exportLogBtn.addEventListener('click', () => {
      const logText = logContainer.innerText;
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `system-log-${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      logMessage('Log esportato', 'success');
    });

    // Nuovi event listeners per il controllo slider
    sliderToggle.addEventListener('change', () => {
      updateSlidersState(sliderToggle.checked);
    });

    enableAllSlidersBtn.addEventListener('click', () => {
      updateSlidersState(true);
      // Abilita tutti gli slider individualmente
      for (let i = 1; i <= 7; i++) {
        enableSlider(i);
      }
    });

    disableAllSlidersBtn.addEventListener('click', () => {
      updateSlidersState(false);
      // Disabilita tutti gli slider individualmente
      for (let i = 1; i <= 7; i++) {
        disableSlider(i);
      }
    });

    // MODIFICATO: Reset globale degli slider
    resetSlidersBtn.addEventListener('click', () => {
      // Invia il comando di reset al server
      const resetMessage = {
        type: "slider_reset",
        timestamp: Date.now()
      };
      
      if (sendWebSocketMessage(resetMessage)) {
        logMessage('Comando reset globale slider inviato al server', 'success');
        
        // Aggiorna anche i valori visualizzati nell'admin panel
        for (let i = 1; i <= 7; i++) {
          updateSliderValue(i, 50);
        }
      } else {
        logMessage('Errore nell\'invio del comando reset', 'error');
      }
    });

    // Ascolta messaggi dalla pagina principale
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'questionnaireCompleted') {
        updateQuestionnaireStatus();
        logMessage('Questionario completato dalla pagina principale', 'info');
      }
    });
  </script>
</body>
</html>
