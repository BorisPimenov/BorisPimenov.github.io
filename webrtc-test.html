<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Client - TouchDesigner</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px; margin: 5px; }
        video { width: 100%; max-width: 800px; background: #000; }
        .log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>ğŸ¥ WebRTC Client - TouchDesigner</h1>
    
    <button onclick="connect()">ğŸ”— Connetti a Heroku</button>
    <button onclick="joinRoom()">ğŸ¯ Entra in Stanza</button>
    <button onclick="disconnect()">âŒ Disconnetti</button>
    
    <div>
        <h2>ğŸ“¹ Video</h2>
        <video id="video" autoplay playsinline muted></video>
    </div>
    
    <div>
        <h3>ğŸ“‹ Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        // âœ… SOSTITUISCI QUESTO CON L'URL DELLA TUA APP HEROKU
        const HEROKU_APP_URL = 'eburnea-fixed-f2da05b9b297.herokuapp.com';
        
        let websocket = null;
        let peerConnection = null;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function connect() {
            log('ğŸ”„ Connessione a Heroku...');
            
            const wsUrl = `wss://${HEROKU_APP_URL}`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = () => {
                log('âœ… Connesso a Heroku!');
            };

            websocket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`ğŸ“¨ Ricevuto: ${message.type}`);
                    handleWebRTCMessage(message);
                } catch (error) {
                    log('âŒ Errore messaggio: ' + error);
                }
            };

            websocket.onclose = () => {
                log('âŒ Disconnesso da Heroku');
            };

            websocket.onerror = (error) => {
                log('âŒ Errore WebSocket');
            };
        }

        function handleWebRTCMessage(message) {
            if (!peerConnection) {
                setupWebRTC();
            }

            switch (message.type) {
                case 'webrtc-offer':
                    handleOffer(message);
                    break;
                case 'webrtc-candidate':
                    handleCandidate(message);
                    break;
            }
        }

        function setupWebRTC() {
            log('ğŸ”„ Setup WebRTC...');
            
            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            peerConnection.ontrack = (event) => {
                log('ğŸ¥ Video ricevuto!');
                if (event.streams[0]) {
                    document.getElementById('video').srcObject = event.streams[0];
                }
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendMessage({
                        type: 'webrtc-candidate',
                        candidate: event.candidate
                    });
                }
            };
        }

        async function handleOffer(offer) {
            log('ğŸ“¥ Offerta ricevuta');
            await peerConnection.setRemoteDescription(offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            sendMessage({
                type: 'webrtc-answer',
                sdp: answer.sdp,
                type: answer.type
            });
        }

        async function handleCandidate(candidate) {
            if (peerConnection && candidate.candidate) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate.candidate));
            }
        }

        function joinRoom() {
            if (!websocket) {
                log('âŒ Prima connettiti a Heroku');
                return;
            }
            
            log('ğŸ¯ Entro nella stanza');
            sendMessage({
                type: 'webrtc-join',
                room: 'live'
            });
        }

        function sendMessage(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(message));
                log(`ğŸ“¤ Invio: ${message.type}`);
            } else {
                log('âŒ WebSocket non connesso');
            }
        }

        function disconnect() {
            log('ğŸ”„ Disconnessione...');
            if (websocket) websocket.close();
            if (peerConnection) peerConnection.close();
        }

        log('âœ… Client pronto - Connetti a Heroku!');
    </script>
</body>
</html>
