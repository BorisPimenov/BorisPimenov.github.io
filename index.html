<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Panel</title>
  <link rel="stylesheet" href="style (3).css">
  <link rel="stylesheet" href="questionnaire-simple.css">
 
  <style>
    /* BACKGROUND NERO E RESET PER QUESTIONARIO */
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      height: 100vh;
    }

    /* CONTENITORE PRINCIPALE */
    #main-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    /* OVERLAY PER CATTURARE IL MOUSE IN MODALITÃ€ IMMERSIVA */
    .mouse-catcher {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 7999; /* Sotto l'UI ma sopra il video */
      pointer-events: none;
    }

    body.immersive-mode .mouse-catcher.active {
      pointer-events: auto;
    }

    /* QUESTIONARIO CON POSIZIONE FISSA IN BASSO */
    #questionnaire.questionnaire-overlay {
      position: fixed !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      width: 90% !important;
      max-width: 600px !important;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      padding: 0 !important;
      z-index: 10000 !important;
      bottom: 30px !important;
      pointer-events: auto !important;
      opacity: 1;
      transition: opacity 0.5s ease, transform 0.5s ease;
      transform: translateX(-50%) translateY(0) !important;
    }

    /* Questionario nascosto */
    #questionnaire.questionnaire-overlay.hidden {
      opacity: 0 !important;
      transform: translateX(-50%) translateY(20px) !important;
      pointer-events: none !important;
    }

    /* Quando il questionario Ã¨ in focus, rimane sempre visibile */
    #questionnaire.questionnaire-overlay.input-focused {
      opacity: 1 !important;
      transform: translateX(-50%) translateY(0) !important;
      pointer-events: auto !important;
    }

    /* In modalitÃ  fullscreen, assicuriamoci che il questionario rimanga accessibile */
    :fullscreen #questionnaire,
    :-webkit-full-screen #questionnaire,
    :-moz-full-screen #questionnaire,
    :-ms-fullscreen #questionnaire {
      position: fixed !important;
      bottom: 30px !important;
      left: 50% !important;
      transform: translateX(-50%) translateY(0) !important;
    }

    .questionnaire-container {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .questions-form {
      background: rgba(0, 0, 0, 0.3) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 8px !important;
      padding: 10px 15px !important;
      display: flex !important;
      align-items: center !important;
      gap: 10px !important;
      backdrop-filter: blur(5px) !important;
      transition: background-color 0.3s ease;
    }

    /* Highlight quando il form Ã¨ attivo */
    .questions-form.active {
      background: rgba(0, 0, 0, 0.5) !important;
      border-color: rgba(255, 255, 255, 0.4) !important;
    }

    .question-input {
      background: transparent !important;
      border: none !important;
      color: white !important;
      flex-grow: 1 !important;
      padding: 10px !important;
      font-size: 16px !important;
    }

    .question-input::placeholder {
      color: rgba(255, 255, 255, 0.7) !important;
    }

    .submit-arrow {
      background: transparent !important;
      border: none !important;
      padding: 5px !important;
    }

    .submit-arrow svg {
      fill: white !important;
    }

    /* VIDEO CONTAINER INIZIALE (al centro) */
    .video-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      height: 180px;
      z-index: 9000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      background: #000;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* MODALITÃ€ IMMERSIVA - TUTTO LO SCHERMO */
    body.immersive-mode .video-container {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      transform: none !important;
      border-radius: 0 !important;
      z-index: 8000 !important;
      cursor: default !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* Quando in modalitÃ  immersiva, il questionario rimane sopra */
    body.immersive-mode #questionnaire {
      z-index: 10001 !important;
    }
    
    #backgroundVideo {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* CONTROLLI VIDEO - POSIZIONATI IN ALTO A DESTRA */
    .video-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 9001;
      opacity: 1;
      transition: opacity 0.5s ease, transform 0.5s ease;
      transform: translateY(0);
    }
    
    /* Classe per nascondere i controlli */
    .video-controls.hidden {
      opacity: 0 !important;
      transform: translateY(-10px);
      pointer-events: none;
    }
    
    .video-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(5px);
    }
    
    .video-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: white;
      transform: translateY(-1px);
    }
    
    .video-btn svg {
      width: 14px;
      height: 14px;
    }
    
    /* PULSANTE ESC PER USCIRE DAL FULLSCREEN */
    .exit-hint {
      position: fixed;
      top: 10px;
      left: 10px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      z-index: 10002;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 4px;
      display: none;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    
    .exit-hint.hidden {
      opacity: 0;
    }

    body.immersive-mode .exit-hint {
      display: block;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .video-container {
        width: 280px;
        height: 157px;
      }
      
      #questionnaire.questionnaire-overlay {
        width: 85% !important;
        bottom: 20px !important;
      }
      
      /* Su mobile, i controlli sono sempre visibili */
      .video-controls {
        opacity: 1 !important;
      }
      
      .video-controls.hidden {
        opacity: 1 !important;
        transform: none !important;
        pointer-events: auto !important;
      }
      
      /* Su mobile, il questionario Ã¨ sempre visibile */
      #questionnaire.questionnaire-overlay.hidden {
        opacity: 1 !important;
        transform: translateX(-50%) translateY(0) !important;
        pointer-events: auto !important;
      }
    }
    
    @media (max-width: 480px) {
      .video-container {
        width: 250px;
        height: 140px;
      }
      
      .video-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    /* Nascondi la scrollbar in modalitÃ  immersiva */
    body.immersive-mode {
      overflow: hidden !important;
    }
    
    /* Cursore nascosto in modalitÃ  immersiva dopo inattivitÃ  */
    body.immersive-mode.cursor-hidden {
      cursor: none !important;
    }
  </style>
</head>
<body>
  <script>
    if (window.location.search.includes('mobile=1')) {
      document.body.classList.add('force-mobile');
    }
  </script>

  <div id="main-container">
    <!-- OVERLAY PER CATTURARE IL MOUSE IN MODALITÃ€ IMMERSIVA -->
    <div id="mouseCatcher" class="mouse-catcher"></div>

    <!-- CONTAINER VIDEO CON CONTROLLI -->
    <div class="video-container">
      <div class="video-controls">
        <button class="video-btn" id="immersiveBtn" title="ModalitÃ  Immersiva">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
          <span>ModalitÃ  Immersiva</span>
        </button>
        <button class="video-btn" id="audioBtn" title="Attiva Audio">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v9.27c-.47-.17-.97-.27-1.5-.27C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
          </svg>
          <span>Audio OFF</span>
        </button>
      </div>
      <iframe 
        id="backgroundVideo"
        src="https://vdo.ninja/?view=Ha93mG8&clean&autoplay&mute=1&noheader&nofooter&transparent&border=0&nochat&nofullscreenbutton" 
        frameborder="0"
        allow="autoplay; encrypted-media; fullscreen"
        title="Live Stream">
      </iframe>
    </div>

    <!-- HINT PER USCITA -->
    <div class="exit-hint">Premi ESC per uscire</div>

    <!-- QUESTIONARIO SEMPLIFICATO (centrato e trasparente) -->
    <div id="questionnaire" class="questionnaire-overlay">
      <div class="questionnaire-container">
        <form id="questionsForm" class="questions-form">
          <input type="text" class="question-input" name="message" 
                placeholder="Scrivi qui il tuo messaggio..." 
                maxlength="500" required
                aria-label="Messaggio dello spettatore">
          
          <button type="submit" class="submit-arrow" title="Invia messaggio">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPALE -->
  <script>
    // 1. FUNZIONI GLOBALI WEB SOCKET
    function sendToTouchDesigner(message) {
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
            window.ws.send(JSON.stringify(message));
            console.log('ðŸ“¤ Messaggio inviato:', message);
        } else {
            console.log('âš ï¸ WebSocket non connesso, messaggio non inviato:', message);
            if (!window.pendingMessages) window.pendingMessages = [];
            window.pendingMessages.push(message);
        }
    }
    window.sendToTouchDesigner = sendToTouchDesigner;

    // 2. GESTIONE VIDEO CON AUDIO, MODALITÃ€ IMMERSIVA E NASCONDI CONTROLLI
    document.addEventListener('DOMContentLoaded', function() {
        const videoContainer = document.querySelector('.video-container');
        const immersiveBtn = document.getElementById('immersiveBtn');
        const audioBtn = document.getElementById('audioBtn');
        const videoIframe = document.getElementById('backgroundVideo');
        const videoControls = document.querySelector('.video-controls');
        const exitHint = document.querySelector('.exit-hint');
        const questionnaire = document.getElementById('questionnaire');
        const questionInput = document.querySelector('.question-input');
        const questionsForm = document.querySelector('.questions-form');
        const mouseCatcher = document.getElementById('mouseCatcher');
        const audioSpan = audioBtn.querySelector('span');
        const body = document.body;
        
        let isMuted = true;
        let isImmersive = false;
        let mouseMoveTimer = null;
        let controlsHideTimer = null;
        let isInputFocused = false;
        const HIDE_DELAY = 2000; // 2 secondi di inattivitÃ  prima di nascondere
        const MOBILE_BREAKPOINT = 768;

        // Funzione per mostrare tutti gli elementi UI
        function showUI() {
            if (videoControls) {
                videoControls.classList.remove('hidden');
            }
            if (exitHint && isImmersive) {
                exitHint.classList.remove('hidden');
                // Riavvia l'animazione dell'hint
                exitHint.style.animation = 'none';
                setTimeout(() => {
                    exitHint.style.animation = 'fadeInOut 3s ease-in-out';
                }, 10);
            }
            if (questionnaire && isImmersive && !isMobileDevice()) {
                questionnaire.classList.remove('hidden');
            }
            if (body.classList.contains('cursor-hidden')) {
                body.classList.remove('cursor-hidden');
            }
            if (mouseCatcher && isImmersive) {
                mouseCatcher.classList.remove('active');
            }
            
            // Reset del timer per nascondere gli elementi
            resetHideTimer();
        }

        // Funzione per nascondere tutti gli elementi UI
        function hideUI() {
            // Non nascondere se l'input Ã¨ in focus
            if (isInputFocused) {
                return;
            }
            
            if (isImmersive && !isMobileDevice()) {
                if (videoControls) {
                    videoControls.classList.add('hidden');
                }
                if (exitHint) {
                    exitHint.classList.add('hidden');
                }
                if (questionnaire && !isInputFocused) {
                    questionnaire.classList.add('hidden');
                }
                // Nasconde anche il cursore in modalitÃ  immersiva
                body.classList.add('cursor-hidden');
                // Attiva l'overlay per catturare gli eventi del mouse
                if (mouseCatcher) {
                    mouseCatcher.classList.add('active');
                }
            }
        }

        // Funzione per resettare il timer di nascondimento
        function resetHideTimer() {
            if (controlsHideTimer) {
                clearTimeout(controlsHideTimer);
            }
            // Solo in modalitÃ  immersiva nascondiamo gli elementi UI
            if (isImmersive && !isMobileDevice() && !isInputFocused) {
                controlsHideTimer = setTimeout(hideUI, HIDE_DELAY);
            }
        }

        // Rileva se Ã¨ un dispositivo mobile
        function isMobileDevice() {
            return window.innerWidth <= MOBILE_BREAKPOINT || 
                   /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Funzione per gestire il movimento del mouse
        function handleMouseMove() {
            // Annulla il timer del movimento del mouse
            if (mouseMoveTimer) {
                clearTimeout(mouseMoveTimer);
            }
            
            // Mostra gli elementi UI
            showUI();
            
            // Imposta un timer per controllare se il mouse si Ã¨ fermato
            mouseMoveTimer = setTimeout(() => {
                // Dopo che il mouse si Ã¨ fermato, inizia il timer per nascondere gli elementi UI
                resetHideTimer();
            }, 300);
        }

        // Gestione focus sull'input del questionario
        function handleInputFocus() {
            isInputFocused = true;
            if (questionnaire) {
                questionnaire.classList.remove('hidden');
                questionnaire.classList.add('input-focused');
            }
            if (questionsForm) {
                questionsForm.classList.add('active');
            }
            showUI(); // Mostra anche gli altri elementi quando l'input Ã¨ in focus
        }

        // Gestione blur sull'input del questionario
        function handleInputBlur() {
            isInputFocused = false;
            if (questionnaire) {
                questionnaire.classList.remove('input-focused');
            }
            if (questionsForm) {
                questionsForm.classList.remove('active');
            }
            // Dopo aver perso il focus, riavvia il timer per nascondere
            resetHideTimer();
        }

        // Funzione per attivare/disattivare audio
        function toggleAudio() {
            isMuted = !isMuted;
            
            audioSpan.textContent = isMuted ? 'Audio OFF' : 'Audio ON';
            
            const audioIcon = audioBtn.querySelector('svg');
            if (isMuted) {
                audioIcon.innerHTML = '<path d="M12 3v9.27c-.47-.17-.97-.27-1.5-.27C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>';
            } else {
                audioIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
            }
            
            const currentSrc = videoIframe.src;
            let newSrc;
            
            if (isMuted) {
                newSrc = currentSrc.replace(/mute=\d/, 'mute=1');
                if (!newSrc.includes('mute=')) {
                    newSrc = currentSrc + '&mute=1';
                }
            } else {
                newSrc = currentSrc.replace(/mute=\d/, 'mute=0');
                if (!newSrc.includes('mute=')) {
                    newSrc = currentSrc + '&mute=0';
                }
            }
            
            videoIframe.src = newSrc;
            console.log(`ðŸ”Š Audio ${isMuted ? 'disattivato' : 'attivato'}`);
            
            sendToTouchDesigner({
                type: "audio_toggle",
                muted: isMuted,
                timestamp: Date.now()
            });
            
            // Mostra gli elementi UI quando si interagisce
            showUI();
        }

        // Funzione per attivare/disattivare modalitÃ  immersiva
        function toggleImmersiveMode() {
            isImmersive = !isImmersive;
            
            if (isImmersive) {
                // Entra in modalitÃ  immersiva
                body.classList.add('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Uscire';
                
                // Mostra gli elementi UI all'entrata
                showUI();
                
                // Cerca di entrare in fullscreen nativo
                if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                    !document.mozFullScreenElement && !document.msFullscreenElement) {
                    
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    }
                }
                
                console.log('ðŸ”„ ModalitÃ  immersiva attivata');
                
            } else {
                // Esci dalla modalitÃ  immersiva
                body.classList.remove('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'ModalitÃ  Immersiva';
                
                // Mostra gli elementi UI all'uscita
                showUI();
                
                // Esci dal fullscreen nativo se attivo
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                console.log('âŒ Uscito dalla modalitÃ  immersiva');
            }
            
            sendToTouchDesigner({
                type: "immersive_mode",
                active: isImmersive,
                timestamp: Date.now()
            });
        }

        // Gestione eventi fullscreen per sincronizzazione
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isFullscreenNow = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                     document.mozFullScreenElement || document.msFullscreenElement);
            
            // Sincronizza lo stato della modalitÃ  immersiva con il fullscreen
            if (isFullscreenNow && !isImmersive) {
                isImmersive = true;
                body.classList.add('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Uscire';
                showUI();
            } else if (!isFullscreenNow && isImmersive) {
                isImmersive = false;
                body.classList.remove('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'ModalitÃ  Immersiva';
                showUI();
            }
        }

        // Tasti ESC per uscire
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isImmersive) {
                toggleImmersiveMode();
            }
            // Mostra gli elementi UI quando si preme un tasto
            showUI();
        });

        // Event listeners per il movimento del mouse
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseenter', showUI);
        
        // Event listener per il mouse catcher
        if (mouseCatcher) {
            mouseCatcher.addEventListener('mousemove', handleMouseMove);
            mouseCatcher.addEventListener('click', showUI);
        }
        
        // Event listeners per i bottoni
        if (immersiveBtn) {
            immersiveBtn.addEventListener('click', toggleImmersiveMode);
            immersiveBtn.addEventListener('mouseenter', showUI);
        }
        
        if (audioBtn) {
            audioBtn.addEventListener('click', toggleAudio);
            audioBtn.addEventListener('mouseenter', showUI);
        }
        
        // Gestione focus/blur per l'input del questionario
        if (questionInput) {
            questionInput.addEventListener('focus', handleInputFocus);
            questionInput.addEventListener('blur', handleInputBlur);
            questionInput.addEventListener('input', showUI);
            questionInput.addEventListener('keydown', showUI);
        }
        
        // Gestione del form del questionario
        if (questionsForm) {
            questionsForm.addEventListener('mouseenter', showUI);
            questionsForm.addEventListener('click', showUI);
        }
        
        const submitButton = document.querySelector('.submit-arrow');
        if (submitButton) {
            submitButton.addEventListener('click', function() {
                showUI();
                // Dopo l'invio, mantieni l'UI visibile per un po'
                setTimeout(resetHideTimer, 3000);
            });
        }
        
        // Doppio click sul video per modalitÃ  immersiva
        videoContainer.addEventListener('dblclick', function(e) {
            toggleImmersiveMode();
            showUI();
        });
        
        // Click sul video mostra gli elementi UI
        videoContainer.addEventListener('click', function(e) {
            showUI();
        });
        
        // Anche il questionario mostra gli elementi UI quando interagito
        if (questionnaire) {
            questionnaire.addEventListener('mouseenter', showUI);
            questionnaire.addEventListener('click', showUI);
        }
        
        // Inizializzazione: mostra gli elementi UI all'avvio
        setTimeout(showUI, 1000);
        
        console.log('â–¶ï¸ Video VDO.Ninja avviato al centro');
    });

    // 3. WEB SOCKET CONNECTION
    console.log('ðŸ”„ Tentativo di connessione WebSocket...');
    const ws = new WebSocket('wss://eburnea-fixed-f2da05b9b297.herokuapp.com');
    window.ws = ws;

    ws.onopen = function(event) {
        console.log('âœ…âœ…âœ… WEB SOCKET CONNESSO!');
        
        sendToTouchDesigner({
            type: "test",
            message: "Connessione test",
            timestamp: Date.now()
        });
    };

    ws.onclose = function(event) {
        console.log('âŒâŒâŒ WEB SOCKET DISCONNESSO');
        
        setTimeout(() => {
            console.log('ðŸ”„ Tentativo riconnessione...');
            location.reload();
        }, 5000);
    };

    ws.onerror = function(error) {
        console.log('ðŸ’¥ðŸ’¥ðŸ’¥ WEB SOCKET ERROR');
    };

    ws.onmessage = function(event) {
        console.log('ðŸ“© Messaggio dal server:', event.data);
    };
  </script>
  
  <!-- QUESTIONNAIRE SCRIPT -->
  <script src="questionnaire-simple.js"></script>
  
  <!-- ALTRI SCRIPT -->
  <script src="panel-controller.js"></script>
</body>
</html>
