<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Panel</title>
  <link rel="stylesheet" href="style (3).css">
  <link rel="stylesheet" href="questionnaire-simple.css">
 
  <style>
    /* BACKGROUND NERO E RESET PER QUESTIONARIO */
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      height: 100vh;
    }

    /* CONTENITORE PRINCIPALE */
    #main-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    /* QUESTIONARIO CON POSIZIONE FISSA IN BASSO */
    #questionnaire.questionnaire-overlay {
      position: fixed !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      width: 90% !important;
      max-width: 600px !important;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      padding: 0 !important;
      z-index: 10000 !important;
      bottom: 30px !important;
      pointer-events: auto !important;
    }

    /* In modalit√† fullscreen, assicuriamo che il questionario rimanga accessibile */
    :fullscreen #questionnaire,
    :-webkit-full-screen #questionnaire,
    :-moz-full-screen #questionnaire,
    :-ms-fullscreen #questionnaire {
      position: fixed !important;
      bottom: 30px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }

    .questionnaire-container {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .questions-form {
      background: rgba(0, 0, 0, 0.3) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 8px !important;
      padding: 10px 15px !important;
      display: flex !important;
      align-items: center !important;
      gap: 10px !important;
      backdrop-filter: blur(5px) !important;
    }

    .question-input {
      background: transparent !important;
      border: none !important;
      color: white !important;
      flex-grow: 1 !important;
      padding: 10px !important;
      font-size: 16px !important;
    }

    .question-input::placeholder {
      color: rgba(255, 255, 255, 0.7) !important;
    }

    .submit-arrow {
      background: transparent !important;
      border: none !important;
      padding: 5px !important;
    }

    .submit-arrow svg {
      fill: white !important;
    }

    /* VIDEO CONTAINER INIZIALE (al centro) */
    .video-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      height: 180px;
      z-index: 9000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      background: #000;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* MODALIT√Ä IMMERSIVA - TUTTO LO SCHERMO */
    body.immersive-mode .video-container {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      transform: none !important;
      border-radius: 0 !important;
      z-index: 8000 !important;
      cursor: default !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* Quando in modalit√† immersiva, il questionario rimane sopra */
    body.immersive-mode #questionnaire {
      z-index: 10001 !important;
    }
    
    #backgroundVideo {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* CONTROLLI VIDEO - POSIZIONATI IN ALTO A DESTRA */
    .video-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 9001;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }
    
    .video-container:hover .video-controls,
    body.immersive-mode .video-controls {
      opacity: 1;
    }
    
    .video-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(5px);
    }
    
    .video-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: white;
      transform: translateY(-1px);
    }
    
    .video-btn svg {
      width: 14px;
      height: 14px;
    }
    
    /* PULSANTE ESC PER USCIRE DAL FULLSCREEN */
    .exit-hint {
      position: fixed;
      top: 10px;
      left: 10px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      z-index: 10002;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 4px;
      display: none;
      pointer-events: none;
    }

    body.immersive-mode .exit-hint {
      display: block;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .video-container {
        width: 280px;
        height: 157px;
      }
      
      .video-controls {
        opacity: 1;
      }
      
      #questionnaire.questionnaire-overlay {
        width: 85% !important;
        bottom: 20px !important;
      }
    }
    
    @media (max-width: 480px) {
      .video-container {
        width: 250px;
        height: 140px;
      }
      
      .video-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    /* Nascondi la scrollbar in modalit√† immersiva */
    body.immersive-mode {
      overflow: hidden !important;
    }
  </style>
</head>
<body>
  <script>
    if (window.location.search.includes('mobile=1')) {
      document.body.classList.add('force-mobile');
    }
  </script>

  <div id="main-container">
    <!-- CONTAINER VIDEO CON CONTROLLI -->
    <div class="video-container">
      <div class="video-controls">
        <button class="video-btn" id="immersiveBtn" title="Modalit√† Immersiva">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
          <span>Modalit√† Immersiva</span>
        </button>
        <button class="video-btn" id="audioBtn" title="Attiva Audio">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v9.27c-.47-.17-.97-.27-1.5-.27C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
          </svg>
          <span>Audio OFF</span>
        </button>
      </div>
      <iframe 
        id="backgroundVideo"
        src="https://vdo.ninja/?view=Ha93mG8&clean&autoplay&mute=1&noheader&nofooter&transparent&border=0&nochat&nofullscreenbutton" 
        frameborder="0"
        allow="autoplay; encrypted-media; fullscreen"
        title="Live Stream">
      </iframe>
    </div>

    <!-- HINT PER USCITA -->
    <div class="exit-hint">Premi ESC per uscire</div>

    <!-- QUESTIONARIO SEMPLIFICATO (centrato e trasparente) -->
    <div id="questionnaire" class="questionnaire-overlay">
      <div class="questionnaire-container">
        <form id="questionsForm" class="questions-form">
          <input type="text" class="question-input" name="message" 
                placeholder="Scrivi qui il tuo messaggio..." 
                maxlength="500" required
                aria-label="Messaggio dello spettatore">
          
          <button type="submit" class="submit-arrow" title="Invia messaggio">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPALE -->
  <script>
    // 1. FUNZIONI GLOBALI WEB SOCKET
    function sendToTouchDesigner(message) {
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
            window.ws.send(JSON.stringify(message));
            console.log('üì§ Messaggio inviato:', message);
        } else {
            console.log('‚ö†Ô∏è WebSocket non connesso, messaggio non inviato:', message);
            if (!window.pendingMessages) window.pendingMessages = [];
            window.pendingMessages.push(message);
        }
    }
    window.sendToTouchDesigner = sendToTouchDesigner;

    // 2. GESTIONE VIDEO CON AUDIO E MODALIT√Ä IMMERSIVA
    document.addEventListener('DOMContentLoaded', function() {
        const videoContainer = document.querySelector('.video-container');
        const immersiveBtn = document.getElementById('immersiveBtn');
        const audioBtn = document.getElementById('audioBtn');
        const videoIframe = document.getElementById('backgroundVideo');
        const audioSpan = audioBtn.querySelector('span');
        const body = document.body;
        
        let isMuted = true;
        let isImmersive = false;

        // Funzione per attivare/disattivare audio
        function toggleAudio() {
            isMuted = !isMuted;
            
            audioSpan.textContent = isMuted ? 'Audio OFF' : 'Audio ON';
            
            const audioIcon = audioBtn.querySelector('svg');
            if (isMuted) {
                audioIcon.innerHTML = '<path d="M12 3v9.27c-.47-.17-.97-.27-1.5-.27C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>';
            } else {
                audioIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
            }
            
            const currentSrc = videoIframe.src;
            let newSrc;
            
            if (isMuted) {
                newSrc = currentSrc.replace(/mute=\d/, 'mute=1');
                if (!newSrc.includes('mute=')) {
                    newSrc = currentSrc + '&mute=1';
                }
            } else {
                newSrc = currentSrc.replace(/mute=\d/, 'mute=0');
                if (!newSrc.includes('mute=')) {
                    newSrc = currentSrc + '&mute=0';
                }
            }
            
            videoIframe.src = newSrc;
            console.log(`üîä Audio ${isMuted ? 'disattivato' : 'attivato'}`);
            
            sendToTouchDesigner({
                type: "audio_toggle",
                muted: isMuted,
                timestamp: Date.now()
            });
        }

        // Funzione per attivare/disattivare modalit√† immersiva
        function toggleImmersiveMode() {
            isImmersive = !isImmersive;
            
            if (isImmersive) {
                // Entra in modalit√† immersiva
                body.classList.add('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Uscire';
                
                // Cerca di entrare in fullscreen nativo
                if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                    !document.mozFullScreenElement && !document.msFullscreenElement) {
                    
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    }
                }
                
                console.log('üîÑ Modalit√† immersiva attivata');
                
            } else {
                // Esci dalla modalit√† immersiva
                body.classList.remove('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Modalit√† Immersiva';
                
                // Esci dal fullscreen nativo se attivo
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                console.log('‚ùå Uscito dalla modalit√† immersiva');
            }
            
            sendToTouchDesigner({
                type: "immersive_mode",
                active: isImmersive,
                timestamp: Date.now()
            });
        }

        // Gestione eventi fullscreen per sincronizzazione
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isFullscreenNow = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                     document.mozFullScreenElement || document.msFullscreenElement);
            
            // Sincronizza lo stato della modalit√† immersiva con il fullscreen
            if (isFullscreenNow && !isImmersive) {
                isImmersive = true;
                body.classList.add('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Uscire';
            } else if (!isFullscreenNow && isImmersive) {
                isImmersive = false;
                body.classList.remove('immersive-mode');
                immersiveBtn.querySelector('span').textContent = 'Modalit√† Immersiva';
            }
        }

        // Tasti ESC per uscire
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isImmersive) {
                toggleImmersiveMode();
            }
        });

        // Event listeners
        if (immersiveBtn) {
            immersiveBtn.addEventListener('click', toggleImmersiveMode);
        }
        
        if (audioBtn) {
            audioBtn.addEventListener('click', toggleAudio);
        }
        
        // Doppio click sul video per modalit√† immersiva
        videoContainer.addEventListener('dblclick', toggleImmersiveMode);
        
        console.log('‚ñ∂Ô∏è Video VDO.Ninja avviato al centro');
    });

    // 3. WEB SOCKET CONNECTION
    console.log('üîÑ Tentativo di connessione WebSocket...');
    const ws = new WebSocket('wss://eburnea-fixed-f2da05b9b297.herokuapp.com');
    window.ws = ws;

    ws.onopen = function(event) {
        console.log('‚úÖ‚úÖ‚úÖ WEB SOCKET CONNESSO!');
        
        sendToTouchDesigner({
            type: "test",
            message: "Connessione test",
            timestamp: Date.now()
        });
    };

    ws.onclose = function(event) {
        console.log('‚ùå‚ùå‚ùå WEB SOCKET DISCONNESSO');
        
        setTimeout(() => {
            console.log('üîÑ Tentativo riconnessione...');
            location.reload();
        }, 5000);
    };

    ws.onerror = function(error) {
        console.log('üí•üí•üí• WEB SOCKET ERROR');
    };

    ws.onmessage = function(event) {
        console.log('üì© Messaggio dal server:', event.data);
    };
  </script>
  
  <!-- QUESTIONNAIRE SCRIPT -->
  <script src="questionnaire-simple.js"></script>
  
  <!-- ALTRI SCRIPT -->
  <script src="panel-controller.js"></script>
</body>
</html>
